<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>ChCore object机制理解 | ybhuang</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.1.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ChCore object机制理解</h1><a id="logo" href="/.">ybhuang</a><p class="description">ybhuang's official website</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ChCore object机制理解</h1><div class="post-meta">2020-09-16<span> | </span><span class="category"><a href="/categories/ipads/">ipads</a></span></div><div class="post-content"><p>struct object {<br>    u64 type;<br>    u64 size;<br>    /* Link all slots point to this object /<br>    struct list_head copies_head;<br>    / Currently only protect copies list /<br>    struct lock copies_lock;<br>    /<br>     * refcount is added when a slot points to it and when get_object is<br>     * called. Object is freed when it reaches 0.<br>     /<br>    u64 refcount;<br>    /<br>     * opaque marks the end of this struct and the real object will be<br>     * stored here. Now its address will be 8-byte aligned.<br>     */<br>    u64 opaque[];<br>};<br>enum object_type {<br>    TYPE_CAP_GROUP = 0,<br>    TYPE_THREAD,<br>    TYPE_CONNECTION,<br>    TYPE_NOTIFICATION,<br>    TYPE_IRQ,<br>    TYPE_PMO,<br>    TYPE_VMSPACE,<br>    TYPE_NR,<br>};<br>    此数据结构会attach在每个使用obj_alloc分配的内存的前面，其中type字段指明了此object的类型，之后copies_head和refcount会指明每个指向这个object的slot，opaque则指向实际的数据（可以是很多类型，不一定是PMO）。</p>
<p>struct pmobject {<br>    struct radix <em>radix; /</em> record physical pages /<br>    paddr_t start;<br>    size_t size;<br>    pmo_type_t type;<br>};<br>typedef u64 pmo_type_t;<br>#define PMO_ANONYM     0 / lazy allocation /<br>#define PMO_DATA       1 / immediate allocation /<br>#define PMO_FILE       2 / file backed /<br>#define PMO_SHM        3 / shared memory /<br>#define PMO_USER_PAGER 4 / support user pager /<br>#define PMO_DEVICE     5 / memory mapped device registers */<br>    此数据结构的radix被拿来记录PMO_SHM的物理页（仅仅只是PMO_SHM,其它类型均不使用此字段），start记录了实际内存区域起始物理地址，size记录了实际内存区域大小，type记录了该PMO的TYPE。（这里是PMO_DATA）</p>
<p>struct object_slot {<br>    u64 slot_id;<br>    struct cap_group <em>cap_group;<br>    /</em> TODO: As bitmap is used, isvalid should be removed. Leave here to debug /<br>    int isvalid;<br>    / TODO: extern rights to a more general per-cap data storage of an object */<br>    u64 rights;<br>    struct object <em>object;<br>    /</em> link copied slots pointing to the same object */<br>    struct list_head copies;<br>};<br>    此数据结构通过object成员记录了一个pmo（object-&gt;pmo-&gt;memory），并且映射了同一个object的object_slot会被copies连接在一起形成一个链表，slot_id记录了该object_slot的id。</p>
<p>struct slot_table {<br>    unsigned int slots_size;<br>    struct object_slot *slots;<br>    /<br>     * if a bit in full_slots_bmp is 1, corresponding<br>     * sizeof(unsigned long) bits in slots_bmp are all set<br>     */<br>    unsigned long *full_slots_bmp;<br>    unsigned long slots_bmp;<br>     / XXX: Protect mapping of slot_id to slot. Maybe RCU is more suitable /<br>    struct rwlock table_guard;<br>};<br>    此数据结构通过slots保存了object_slot的一个集合，形式为链表，大小为BITS_PER_LONG，并且使用bitmap来显示分配情况,具体为full_slots_bmp表示64位的slots集合块，如果为1就表示这64块slot全部被占了，为0则表示部分被占或为空，然后slots_bmp就记录了具体的集合块的信息。</p>
<p>struct cap_group {<br>    struct slot_table slot_table;<br>    / Proctect thread_list and thread_cnt /<br>    struct lock threads_lock;<br>    struct list_head thread_list;<br>    / The number of threads /<br>    int thread_cnt;<br>    /<br>     * Each process has a unique badge as a global identifier which<br>     * is set by the system server, procmgr.<br>     * Currently, badge is used as a client ID during IPC.<br>     /<br>    u64 badge;<br>    / Ensures the cap_group_exit function only be executed onece /<br>    int notify_recycler;<br>    / Now is used for debugging */<br>    char cap_group_name[MAX_GROUP_NAME_LEN + 1];<br>};<br>    此数据结构使用slot_table保存了一个object_slot集合，保存了共享同一个cap_group的每个线程，并保存了进程的badge。<br>    总的来说，就是cap_group包含一个slot_table的指针，然后slot_table保存了多个object_slot，而object_slot保存了多个struct object,object后面连接着pmo，pmo保存了实际内存区域的物理地址。</p>
<p>void *obj_alloc(u64 type, u64 size):<br>    这个函数会调用kzalloc分配size + sizeof(*object)的内存，然后初始化struct object里的成员，最后返回opaque指针。</p>
<p>void pmo_init(struct pmobject *pmo, pmo_type_t type, size_t len, paddr_t paddr)<br>    这个函数根据传入的type参数来决定自己的行为，先是初始化pmo相应成员字段，若是DATA，则立即分配相应内存，若是SHM/FILE/ANONYM，则初始化radix（不会立即就分配内存，具体radix工作机制尚未研究）。若是DEVICE，则直接将pmo的start赋值为paddr（如DMA，这段内存不会出现在可用物理内存中）。</p>
<p>int alloc_slot_id(struct cap_group *cap_group)<br>    此函数检查cap_group对应的slot_table中的full_slots_bmp有没有0bit，若没有，则直接expand_slot_table，若有，则进一步检查slots_bmp有无空位，若没有，则expand_slot_table，若有，则设置对应bitmap中的bit为1，然后返回slot_id。expand_slot_table则会重新分配一个更大的数组，迁移之前的数据，创建新的bitmap。</p>
<p>int cap_alloc(struct cap_group *cap_group, void *obj, u64 rights)<br>    这个函数先通过container_of来获取object，   然后调用alloc_slot_id函数分配一个slot_id，然后调用malloc分配一个slot，初始化此slot，把此slot link到对应object的copies链表，然后调用install_slot把该slot放入相应slot_table的指定坑位。</p>
<p>int sys_create_pmo(u64 size, u64 type)<br>    这里的type指的是pmobject的类型，这个函数先调用obj_alloc分配一个pmo(实际上是obj+pmo)，调用pmo_init分配size内存，然后调用cap_alloc为该pmo（object）分配一个cap(slot_id，也就是在slot_table中的index)。</p>
<p>void *obj_get(struct cap_group *cap_group, int slot_id, int type)<br>    这个函数就是根据slot_id取出相应的内存首地址，并且把相应的refcnt++。</p>
<p>void obj_put(void *obj)<br>    这个函数什么也不做，只是把object的refcnt–，并检查–之前是否为1，若为1则free_object。</p>
<p>int __cap_free(struct cap_group *cap_group, int slot_id,<br>           bool slot_table_locked, bool copies_list_locked)<br>    这个函数首先free slot_id，然后remove slot，最后把相应的refcnt–，若之后为1，则free之。</p>
<p>int cap_free_all(struct cap_group *cap_group, int slot_id)<br>    这个函数将cap_group中对应的slot_id中object的所有对应的指向这个object的slot调用cap_free，也就是把指向了这个object的slot全部free掉，最后又cap_free自动释放内存。  </p>
<p>int cap_copy(struct cap_group *src_cap_group, struct cap_group *dest_cap_group, int src_slot_id)<br>    这个函数就是在dest_cap_group分配相应的slot_id，连接相应的队列，然后放入object到对应的slot。（后面要使用还需要map_pmo）。</p>
</div><div class="tags"><a href="/tags/chcore/"><i class="fa fa-tag"></i>chcore</a></div><div class="post-nav"><a class="next" href="/2020/09/15/ChCore%E7%BC%96%E8%AF%91+%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83(ubuntu%2018.04)%E6%90%AD%E5%BB%BA%EF%BC%9A/">ChCore开发环境搭建</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ipads/">ipads</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/chcore/" style="font-size: 15px;">chcore</a> <a href="/tags/qemu/" style="font-size: 15px;">qemu</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/09/16/ChCore%20object%E6%9C%BA%E5%88%B6%E7%90%86%E8%A7%A3/">ChCore object机制理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/15/ChCore%E7%BC%96%E8%AF%91+%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83(ubuntu%2018.04)%E6%90%AD%E5%BB%BA%EF%BC%9A/">ChCore开发环境搭建</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://github.com/Bob-hyb/" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">ybhuang.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>